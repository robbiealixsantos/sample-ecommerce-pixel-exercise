<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or "Mock Shop" }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:,">

  <script>
    // Flags & IDs from server (exposed to JS)
    window.SCENARIOS = {
      skipCheckout: {{ 'true' if SCENARIO_SKIP_CHECKOUT_PIXELS else 'false' }},
      deferAfterConsent: {{ 'true' if SCENARIO_DEFER_FIRST_LOAD_AFTER_CONSENT else 'false' }},
      noSnapPII: {{ 'true' if SCENARIO_NO_SNAP_PII else 'false' }},
      noSnapValues: {{ 'true' if SCENARIO_NO_SNAP_VALUES else 'false' }}
    };
    window.PIXELS = {
      meta: "{{ META_PIXEL_ID }}",
      tiktok: "{{ TIKTOK_PIXEL_ID }}",
      snap: "{{ SNAP_PIXEL_ID }}",
      currency: "{{ CURRENCY or 'USD' }}"
    };

    // Simple consent helpers
    function hasConsent(){ return localStorage.getItem('cookie_consent') === 'yes'; }
    function setConsent(v){ localStorage.setItem('cookie_consent', v ? 'yes' : 'no'); }

    // Scenario #2: defer first load after consent (until page reload)
    function shouldLoadPixels(pathname){
      if (!hasConsent()) return false;
      if (window.SCENARIOS.deferAfterConsent){
        if (!sessionStorage.getItem('pixels_allowed_after_reload')){
          sessionStorage.setItem('pixels_allowed_after_reload','1');
          return false; // first load suppressed
        }
      }
      if (window.SCENARIOS.skipCheckout && pathname.indexOf('/checkout') === 0) return false;
      return true;
    }

    // Boot pixel libraries only if allowed
    (function boot(){
      var allow = shouldLoadPixels(location.pathname);
      if (!allow) return;

      // Meta
      if (window.PIXELS.meta){
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
        n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
        t.src='https://connect.facebook.net/en_US/fbevents.js';s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script');
        fbq('init', window.PIXELS.meta); fbq('track','PageView');
      }

      // TikTok
      if (window.PIXELS.tiktok){
        !function (w, d, t) {
          w.TiktokAnalyticsObject = t; var ttq = w[t] = w[t] || [];
          ttq.methods = ["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
          ttq.setAndDefer = function (t, e) { t[e] = function () { t.push([e].concat(Array.prototype.slice.call(arguments, 0))) } };
          for (var i = 0; i < ttq.methods.length; i++) ttq.setAndDefer(ttq, ttq.methods[i]);
          ttq.instance = function (t) { var e = ttq._i[t] || []; for (var n = 0; n < ttq.methods.length; n++) ttq.setAndDefer(e, ttq.methods[n]); return e };
          ttq.load = function (e, n) { var i = "https://analytics.tiktok.com/i18n/pixel/events.js"; ttq._i = ttq._i || {}; ttq._i[e] = []; ttq._i[e]._u = i; ttq._t = ttq._t || {}; ttq._t[e] = +new Date; ttq._o = ttq._o || {}; ttq._o[e] = n || {}; var o = document.createElement("script"); o.type = "text/javascript"; o.async = !0; o.src = i + "?sdkid=" + e + "&lib=" + t; var a = document.getElementsByTagName("script")[0]; a.parentNode.insertBefore(o, a) };
          ttq.load(window.PIXELS.tiktok); ttq.page();
        }(window, document, 'ttq');
      }

      // Snap
      if (window.PIXELS.snap){
        (function(e,t,n){if(e.snaptr)return;var a=e.snaptr=function(){
        a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};a.queue=[];
        var s='script';var r=t.createElement(s);r.async=!0;r.src=n;
        var u=t.getElementsByTagName(s)[0];u.parentNode.insertBefore(r,u);})(window,document,'https://sc-static.net/scevent.min.js');
        snaptr('init', window.PIXELS.snap);
        snaptr('track','PAGE_VIEW');
      }
    })();
  </script>

  <style>
    .cc-banner { position: fixed; bottom: 0; left: 0; right:0; background: #111827; color: #fff; padding: .75rem 1rem; display: none; z-index: 1000; }
    .cc-banner.show { display: flex; align-items: center; justify-content: space-between; }
    .cc-btn { background: white; color: black; padding: .5rem .75rem; border-radius: .5rem; margin-left: .5rem; }
    .cc-btn.secondary { background: transparent; color: #fff; border: 1px solid #6b7280; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="cookie-consent" class="cc-banner">
    <div><strong>We use cookies</strong> to measure performance. Do you accept analytics pixels?</div>
    <div>
      <button id="cc-accept" class="cc-btn">Accept</button>
      <button id="cc-decline" class="cc-btn secondary">Decline</button>
    </div>
  </div>
  <script>
    (function(){
      var banner = document.getElementById('cookie-consent');
      var accept = document.getElementById('cc-accept');
      var decline = document.getElementById('cc-decline');
      function update(){
        if (!hasConsent()) { banner.classList.add('show'); }
        else { banner.classList.remove('show'); }
      }
      accept.addEventListener('click', function(){
        setConsent(true);
        update();
        if (window.SCENARIOS.deferAfterConsent){
          alert("Consent saved. Reload the page to load pixels (Scenario 1).");
        } else {
          location.reload();
        }
      });
      decline.addEventListener('click', function(){ setConsent(false); update(); });
      update();
    })();
  </script>

  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="{{ url_for('index') }}" class="font-bold text-xl">üõçÔ∏è Mock Shop</a>
      <form action="{{ url_for('index') }}" method="get" class="hidden md:block">
        <input type="text" name="q" value="{{ q or '' }}" placeholder="Search products..." class="border rounded-lg px-3 py-2 w-80">
        <button class="ml-2 px-3 py-2 rounded-lg bg-gray-900 text-white">Search</button>
      </form>
      <a href="{{ url_for('view_cart') }}" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">Cart üß∫</a>
    </div>
  </nav>
  <main class="max-w-6xl mx-auto px-4 py-6">
    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        <div class="space-y-2 mb-6">
          {% for category, msg in messages %}
            <div class="p-3 rounded-lg {% if category == 'success' %}bg-green-100 text-green-900{% elif category == 'error' %}bg-red-100 text-red-900{% else %}bg-blue-100 text-blue-900{% endif %}">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>
  <footer class="py-10 text-center text-sm text-gray-500"><p>¬© {{ 2025 }} Mock Shop ‚Ä¢ Flask</p></footer>
</body>
</html>
